import OpenAI from 'openai';
import { IEgrzRecord } from '../types/egrz.types';
import moment from 'moment';

// –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
const apiKey = process.env.OPENAI_API_KEY;

if (!apiKey) {
	console.warn("–í–ù–ò–ú–ê–ù–ò–ï: API-–∫–ª—é—á –¥–ª—è OpenAI –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ. AI-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –±—É–¥–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–∞.");
}

// –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç OpenAI
const client = new OpenAI({
	apiKey: apiKey,
});

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –ª–∏–¥–µ —Å –ø–æ–º–æ—â—å—é AI –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
 * @param leadData - –û–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ï–ì–†–ó.
 * @param region - –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞.
 * @param beneficiaryInfo - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ–Ω–µ—Ñ–∏—Ü–∏–∞—Ä–µ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.
 * @returns - –°—Ç—Ä–æ–∫–∞ —Å –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
 */


export async function processLeadWithAI(leadData: IEgrzRecord, region: string, beneficiaryInfoSnippet: string): Promise<string> {
	console.log(`[LOG] –®–∞–≥ 3.1: –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ AI –¥–ª—è –∑–∞–ø–∏—Å–∏ "${leadData['–ù–æ–º–µ—Ä –∑–∞–∫–ª—é—á–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã']}".`);
	
	const formattedDate = moment(leadData['–î–∞—Ç–∞ –∑–∞–∫–ª—é—á–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã'], 'DD.MM.YYYY').format('DD.MM.YYYY');
	const developerName = leadData['–°–≤–µ–¥–µ–Ω–∏—è –æ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–µ, –æ–±–µ—Å–ø–µ—á–∏–≤—à–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏'];
	
	const fallbackText = `–ù–æ–≤—ã–π –ª–∏–¥ –∑–∞ ${formattedDate} (—Ä–µ–≥–∏–æ–Ω: ${region})
–ù–æ–º–µ—Ä –∑–∞–∫–ª—é—á–µ–Ω–∏—è: ${leadData['–ù–æ–º–µ—Ä –∑–∞–∫–ª—é—á–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã']}
–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫: ${developerName}`;
	
	if (!apiKey) {
		return fallbackText;
	}
	
	// -- –ò–ó–ú–ï–ù–ï–ù–û: –ù–æ–≤—ã–π, –±–æ–ª–µ–µ —É–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è AI --
	const prompt = `
–¢–≤–æ—è —Ä–æ–ª—å ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏–∑–≤–ª–µ–∫–∞–µ—Ç, —Å–æ–∫—Ä–∞—â–∞–µ—Ç –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞.
–¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –≤–µ—Ä–Ω—É—Ç—å –ü–û–õ–ù–û–°–¢–¨–Æ –≥–æ—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—è –ø—Ä–∞–≤–∏–ª–∞–º.

**–ü–†–ê–í–ò–õ–ê –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –î–ê–ù–ù–´–•:**
1.  **"–ö—Ç–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é" –∏ "–°–≤–µ–¥–µ–Ω–∏—è –æ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–µ":**
    * –ò–∑–≤–ª–µ–∫–∏ –∏ –æ—Å—Ç–∞–≤—å —Ç–æ–ª—å–∫–æ: —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—É—é —Ñ–æ—Ä–º—É (–û–û–û, –ê–û –∏ —Ç.–¥.), –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –∫–∞–≤—ã—á–∫–∞—Ö –∏ –ò–ù–ù. **–í—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–ª—è–π –ò–ù–ù.**
    * **–£–±–∏—Ä–∞–π –û–ì–†–ù**, –µ—Å–ª–∏ –µ—Å—Ç—å –ò–ù–ù.
    * **–î–ª—è –ò–ü:** –û—Å—Ç–∞–≤–ª—è–π –§–ò–û –∏ –û–ì–†–ù–ò–ü.
    * –°–æ–∫—Ä–∞—â–∞–π –∞–¥—Ä–µ—Å (—É–±–∏—Ä–∞–π "–†–æ—Å—Å–∏—è", "–ú–ï–°–¢–û –ù–ê–•–û–ñ–î–ï–ù–ò–Ø", –ª–∏—à–Ω–∏–µ –¥–µ—Ç–∞–ª–∏).
    * **–ü—Ä–∏–º–µ—Ä:** '–û–û–û "–ù–∞–∑–≤–∞–Ω–∏–µ" (–ò–ù–ù: 1234567890, –ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1)'
    * **–ü—Ä–∏–º–µ—Ä –¥–ª—è –ò–ü:** '–ò–ü –ò–≤–∞–Ω–æ–≤ –ò.–ò. (–û–ì–†–ù–ò–ü: 321098765432101, –í–æ–ª–æ–≥–¥–∞, —É–ª. –ú–∏—Ä–∞, –¥. 1)'

2.  **"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞":**
    * –£–±–µ—Ä–∏ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ—Å–ª–µ —Å–ª–æ–≤ "–ü–æ—á—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å:". –û—Å—Ç–∞–≤—å —Ç–æ–ª—å–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞.

3.  **"–°–≤–µ–¥–µ–Ω–∏—è –æ –±–µ–Ω–µ—Ñ–∏—Ü–∏–∞—Ä–∞—Ö" (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û):**
    * **–ï–°–õ–ò "–ù–∞–π–¥–µ–Ω–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç" —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç (–Ω–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è):** –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–≥–æ. –ù–∞–π–¥–∏ –§–ò–û —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è/–¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –∏ —É–∫–∞–∂–∏ –µ–≥–æ —Å –¥–æ–ª–∂–Ω–æ—Å—Ç—å—é. –ü—Ä–∏–º–µ—Ä: "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á".
    * **–ï–°–õ–ò "–ù–∞–π–¥–µ–Ω–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç" —Å–æ–¥–µ—Ä–∂–∏—Ç "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏":** –í –æ—Ç—á–µ—Ç–µ –Ω–∞–ø–∏—à–∏: "–î–∞–Ω–Ω—ã–µ –æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–µ –≤ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
    * **–ï–°–õ–ò "–ù–∞–π–¥–µ–Ω–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç" —Å–æ–¥–µ—Ä–∂–∏—Ç "–°–∫—Ä–∞–ø–∏–Ω–≥ –æ—Ç–∫–ª—é—á–µ–Ω":** –ü–æ–ª–Ω–æ—Å—Ç—å—é **–ø—Ä–æ–ø—É—Å—Ç–∏ –∏ –Ω–µ –≤–∫–ª—é—á–∞–π** –≤ –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –±–ª–æ–∫ "ü§ñ –°–≤–µ–¥–µ–Ω–∏—è –æ –±–µ–Ω–µ—Ñ–∏—Ü–∏–∞—Ä–∞—Ö:".

---
**–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:**
* **–ö–æ–º–ø–∞–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–µ–Ω–µ—Ñ–∏—Ü–∏–∞—Ä–æ–≤:** ${developerName}
* **–ù–∞–π–¥–µ–Ω–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç (—Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫—Ä–∞–ø–∏–Ω–≥–∞):** "${beneficiaryInfoSnippet}"

---
**–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –∏ –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ.**

**–§–û–†–ú–ê–¢ –ò–¢–û–ì–û–í–û–ì–û –û–¢–ß–ï–¢–ê:**
–ù–æ–≤—ã–π –ª–∏–¥ –∑–∞ ${formattedDate} (—Ä–µ–≥–∏–æ–Ω: ${region.split(' - ')[0]})

–ù–æ–º–µ—Ä –∑–∞–∫–ª—é—á–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã: ${leadData['–ù–æ–º–µ—Ä –∑–∞–∫–ª—é—á–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã']}
–†–µ–∑—É–ª—å—Ç–∞—Ç: ${leadData['–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã)']}

üèôÔ∏è –ö—Ç–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:
–æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ ${leadData['–°–≤–µ–¥–µ–Ω–∏—è –æ–± –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è—Ö –∏ (–∏–ª–∏) —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü–∞—Ö, –ø–æ–¥–≥–æ—Ç–æ–≤–∏–≤—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é']}

üè† –°–≤–µ–¥–µ–Ω–∏—è –æ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–µ:
–æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ ${developerName}

üè≠ –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞:
–æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ ${leadData['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å (–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ) –æ–±—ä–µ–∫—Ç–∞ –∫–∞–ø–∏—Ç–∞–ª—å–Ω–æ–≥–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞, –ø—Ä–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –ø—Ä–æ–µ–∫—Ç–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è']}

ü§ñ –°–≤–µ–¥–µ–Ω–∏—è –æ –±–µ–Ω–µ—Ñ–∏—Ü–∏–∞—Ä–∞—Ö:
—Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–≤–æ–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏–ª–∏ –ø–æ–ª–Ω–æ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞, –µ—Å–ª–∏ —Å–∫—Ä–∞–ø–∏–Ω–≥ –æ—Ç–∫–ª—é—á–µ–Ω
`;

	
	console.log('[LOG] –®–∞–≥ 3.2: –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ AI-–∞–Ω–∞–ª–∏—Ç–∏–∫—É...');
	try {
		const response = await client.chat.completions.create({
			model: 'gpt-4o-mini',
			messages: [{ role: 'system', content: prompt }],
			temperature: 0.1,
		});
		
		const result = response.choices[0]?.message?.content?.trim();
		if (result) {
			console.log('[LOG] –®–∞–≥ 3.3: –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –∏ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω –æ—Ç–≤–µ—Ç –æ—Ç AI.');
			return result;
		} else {
			console.warn('[LOG] –í–ù–ò–ú–ê–ù–ò–ï: –û—Ç–≤–µ—Ç –æ—Ç AI –ø—É—Å—Ç–æ–π. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–ø–∞—Å–Ω–æ–π —Ç–µ–∫—Å—Ç.');
			return fallbackText;
		}
		
	} catch (error) {
		console.error('[LOG] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI API:', error);
		return fallbackText;
	}
}